---
title: "Still one Europe, still many electorates? Replicating and exploring a successful model of turnout in European Parliament elections"
author: "A. Seitz"
output: html_notebook
---

# Clean up and load libraries
```{r}
rm(list = ls())
library(QCA)
library(tidyverse)
library(lubridate)
library(miceadds)
```

# Data importing & cleaning

## Load turnout dataset
```{r}
ds <- read.csv("dataset.csv")
```

## Load parlgov dataset for national elections
```{r}
pg <- left_join(
  read.csv("pg_elec.csv") %>% select(election_id, country_name, country_name_short, election_type, election_date),
  read.csv("pg_elec_calc.csv") %>% select(election_id, turnout)
) %>% unique() %>% mutate(Year = year(ymd(election_date)))
```

## Load data on national parliamentary terms
```{r}
terms <- read.csv("terms.csv")
```

## Load OECD employment data
```{r}
agr.oecd <- left_join(
  read.csv("oecd_sector.csv") %>% select(Code = LOCATION, Year = TIME, Agr = Value),
  read.csv("oecd_lf.csv") %>% select(Code = LOCATION, Year = TIME, LF = Value)
) %>% left_join(
  read.csv("oecd_codes.csv")
) %>%
  mutate(AgrShare = Agr / LF) %>%
  filter(!is.na(Country)) %>%
  select(Country, Year, AgrShare)
```

## Load ILO employment data
```{r}
agr.ilostat <- read.csv("ilostat.csv") %>% 
  select(
    Country = ref_area.label,
    Year = time,
    Var = classif1.label,
    Val = obs_value)
agr.ilostat <- left_join(
  agr.ilostat %>% 
    filter(Var == "Economic activity (Aggregate): Agriculture") %>% 
    select(Country, Year, Agr = Val),
  agr.ilostat %>%
    filter(Var == "Economic activity (Aggregate): Total") %>%
    select(Country, Year, Total = Val)
) %>%
  mutate(AgrShare = Agr / Total)
```

## Merge employment datasets
```{r}
agr <- full_join(
  agr.oecd %>% select(Country, Year, AgrShareOecd = AgrShare),
  agr.ilostat %>% select(Country, Year, AgrShareIlostat = AgrShare)
) %>% mutate(AgrShare = rowMeans(cbind(AgrShareOecd, AgrShareIlostat), na.rm = T))
```

## Merge all datasets together
```{r}
ds <- ds %>% left_join(
  pg %>% 
    filter(election_type == "ep") %>% 
    select(Country = country_name, Year, TurnoutPG = turnout, Date = election_date)
) %>%   
  left_join(terms) %>%
  left_join(agr %>% select(Country, Year, AgrShare)) %>%
  drop_na()
```

## Derive national election variables
```{r}
last_national_election <- function(country, date) {
  res <- pg %>% filter(election_type == "parliament" & country_name == country & election_date < date)
  max(res$election_date)
}

ds <- ds %>% mutate(LastNational = mapply(last_national_election, Country, Date))
ds <- ds %>% mutate(Cycle = (interval(LastNational, Date) %/% days(1)) / (365.25 * Term))
ds <- ds %>% mutate(CycleM = interval(LastNational, Date) %/% months(1))
ds <- left_join(ds, pg %>% filter(election_type == "parliament") %>% select(Country = country_name, LastNational = election_date, LastNationalTurnout = turnout))
```

# Definition and calibration of sets for QCA

## T = Turnout (Outcome)
```{r}
qT <- quantile(ds$Turnout, probs = c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9))
qT
```

```{r}
ds$T <- ds$Turnout %>% calibrate(thresholds = c(qT[2], qT[5] + 1, qT[8])) %>% round(digits = 4)
plot(ds$Turnout, ds$T)
```

## C = Compulsory Voting (Binary Condition)
```{r}
ds$C <- 0
ds$C[ds$Country %in% c("Belgium", "Greece", "Luxembourg")] <- 1
ds$C[ds$Country == "Italy" & ds$Year <= 1993] <- 1
ds$C[ds$Country == "Cyprus" & ds$Year <= 2017] <- 1
ds$C[ds$Country == "Bulgaria" & ds$Year >= 2016] <- 1
```

## N = Turnout at previous national (Fuzzy Condition)
```{r}
qN <- quantile(ds$LastNationalTurnout, probs = c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9))
qN
```

```{r}
ds$N <- ds$LastNationalTurnout %>% calibrate(thresholds = c(qN[2], qN[5] + 1, qN[8])) %>% round(digits = 4)
plot(ds$LastNationalTurnout, ds$N)
```

## E = Time in national election cycle (Fuzzy Condition)
```{r}
ds$E <- ds$Cycle %>% calibrate(thresholds = c(0.75, 0.5, 0.25)) %>% round(digits = 4)
plot(ds$Cycle, ds$E)
```

## H = Institution host country? (Binary Condition)
```{r}
ds$H <- 0
ds$H[ds$Country %in% c("Belgium", "Luxembourg", "France")] <- 1
ds$H[ds$Country == "Germany" & ds$Year >= 1999] <- 1
```

## A = Agrarian economy? (Fuzzy Condition)
```{r}
qA <- quantile(ds$AgrShare, probs = c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9))
qA
```

```{r}
ds$A <- ds$AgrShare %>% calibrate(thresholds = c(qA[2], qA[5] + .000001, qA[8])) %>% round(digits = 4)
plot(ds$AgrShare, ds$A)
```

# Qualitative Comparative Analysis

## Label cases
```{r}
ds <- ds %>% mutate(label = paste(Country, Year))
rownames(ds) <- ds$label
```

## Positive outcome (high turnout)

### truth table
```{r}
high.tt <- truthTable(
  ds %>% select(T, C, N, E, H, A), 
  outcome = "T", 
  complete = TRUE, 
  show.cases = TRUE,
  incl.cut = ".8")
high.direxp = "1,1,0,1,1"
high.tt
```

### Conservative solution
```{r}
high.conserv <- minimize(high.tt, details = TRUE)
high.conserv
```

### Parsimonious solution
```{r}
high.parsim <- minimize(high.tt, include = "?", details = TRUE)
high.parsim
```

### Intermediate solution
```{r}
high.interm <- minimize(high.tt, include = "?", dir.exp = high.direxp, details = TRUE)
high.interm
```

## Negative outcome (low turnout)

### Truth table
```{r}
low.tt <- truthTable(
  ds %>% select(T, C, N, E, H, A), 
  outcome = "~T", 
  complete = TRUE, 
  show.cases = TRUE,
  incl.cut = ".8")
low.direxp = "0,0,1,0,0"
low.tt
```

### Conservative solution
```{r}
low.conserv <- minimize(low.tt, details = TRUE)
low.conserv
```

### Parsimonious solution
```{r}
low.parsim <- minimize(low.tt, include = "?", details = TRUE)
low.parsim
```

### Intermediate solution
```{r}
low.interm <- minimize(low.tt, include = "?", dir.exp = low.direxp, details = TRUE)
low.interm
```

# OLS Regression (direct replication / data update of Flickinger & Studlar's Model 4)

```{r}
ds.reg <- ds %>% mutate(AgrShare = AgrShare * 100) %>% mutate(Country = as.factor(Country))
regmod <- lm.cluster(
  data = ds.reg,
  formula = Turnout ~ C + CycleM + LastNationalTurnout + H + AgrShare,
  cluster = "Country")
summary(regmod)
```